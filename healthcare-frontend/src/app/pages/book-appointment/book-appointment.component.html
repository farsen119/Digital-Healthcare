<div class="book-appointment-container">
  <div class="container">
    <div class="row justify-content-center">
      <div class="col-lg-8 col-md-10">
        <div class="appointment-card">
          <!-- Header -->
          <div class="appointment-header">
            <h2 class="appointment-title">
              <i class="fas fa-calendar-plus"></i>
              Book Your Appointment
            </h2>
            <p class="appointment-subtitle">Schedule a consultation with our experienced healthcare professionals</p>
          </div>

          <!-- Form -->
          <form (ngSubmit)="book()" class="appointment-form">
            <!-- Doctor Selection -->
            <div class="form-group">
              <label for="doctor" class="form-label">
                <i class="fas fa-user-md"></i>
                Select Doctor
              </label>
              <select 
                id="doctor"
                [(ngModel)]="form.doctor" 
                name="doctor" 
                class="form-control form-select"
                (ngModelChange)="onDoctorChange()"
                required>
                <option value="" disabled selected>Choose your preferred doctor</option>
                <option *ngFor="let doc of doctors" [value]="doc.id" class="doctor-option">
                  Dr. {{ doc.first_name }} {{ doc.last_name }} - {{ doc.specialization }}
                </option>
              </select>
            </div>

            <!-- Doctor Type Information -->
            <div *ngIf="selectedDoctor" class="doctor-info-alert">
              <div *ngIf="selectedDoctor.doctor_type === 'permanent'" class="alert alert-info">
                <i class="fas fa-users"></i>
                <strong>Permanent Doctor</strong> - This doctor uses a queue system. You'll be added to the queue and consulted when it's your turn.
                <br>
                <small>Current queue position: {{ selectedDoctor.current_queue_position || 0 }}, Max queue size: {{ selectedDoctor.max_queue_size || 10 }}</small>
              </div>
              <div *ngIf="selectedDoctor.doctor_type === 'visiting'" class="alert alert-warning">
                <i class="fas fa-calendar-alt"></i>
                <strong>Visiting Doctor</strong> - This doctor has specific schedules. Please select a date and time slot.
                <br>
                <small>Visiting Days: {{ getVisitingDaysDisplay() }}, Time Slots: {{ getVisitingTimeSlotsDisplay() }}</small>
              </div>
            </div>

            <!-- Date and Time Row -->
            <div class="row">
              <!-- Date Selection -->
              <div class="col-md-6">
                <div class="form-group">
                  <label for="date" class="form-label">
                    <span *ngIf="selectedDoctor?.doctor_type === 'permanent'">Appointment Date (Today)</span>
                    <span *ngIf="selectedDoctor?.doctor_type === 'visiting'">Select Available Date</span>
                  </label>
                  
                  <!-- Permanent Doctor - Fixed Current Date -->
                  <input 
                    *ngIf="selectedDoctor?.doctor_type === 'permanent'"
                    type="date" 
                    id="date"
                    [(ngModel)]="form.date" 
                    name="date" 
                    [value]="getCurrentDate()"
                    readonly>
                  
                  <!-- Visiting Doctor - Available Dates Dropdown -->
                  <select 
                    *ngIf="selectedDoctor?.doctor_type === 'visiting'"
                    id="date"
                    [(ngModel)]="form.date" 
                    name="date" 
                    (ngModelChange)="onDateChange()"
                    [disabled]="loadingDates"
                    required>
                    <option value="" disabled selected>Choose available date</option>
                    <option *ngFor="let date of availableDates" [value]="date.date" class="date-option">
                      {{ date.display }}
                    </option>
                  </select>
                  
                  <div *ngIf="loadingDates" class="mt-2">
                    <small class="text-muted">Loading available dates...</small>
                  </div>
                </div>
              </div>
              
              <!-- Time Selection - Only for Visiting Doctors -->
              <div class="col-md-6" *ngIf="selectedDoctor?.doctor_type === 'visiting'">
                <div class="form-group">
                  <label for="time" class="form-label">
                    <i class="fas fa-clock"></i>
                    Select Available Time Slot
                  </label>
                  
                  <select 
                    id="time"
                    [(ngModel)]="form.time" 
                    name="time" 
                    class="form-control form-select"
                    [disabled]="loadingSlots"
                    required>
                    <option value="" disabled selected>
                      <span *ngIf="!form.date">Select date first</span>
                      <span *ngIf="form.date">Select a time slot</span>
                    </option>
                    <option *ngFor="let slot of timeSlots" [value]="slot.time" class="time-option">
                      {{ slot.display }}
                    </option>
                  </select>
                  
                  <div *ngIf="loadingSlots" class="mt-2">
                    <small class="text-muted">Loading available time slots...</small>
                  </div>
                  
                  <small *ngIf="selectedDoctor && selectedDoctor.doctor_type === 'visiting' && form.date" class="form-text text-muted">
                    <i class="fas fa-info-circle"></i>
                    Available time slots for {{ form.date | date:'fullDate' }}
                  </small>
                </div>
              </div>
            </div>

            <!-- Reason for Visit -->
            <div class="form-group">
              <label for="reason" class="form-label">
                <i class="fas fa-sticky-note"></i>
                Reason for Visit
                <span class="text-danger">*</span>
              </label>
              <textarea 
                id="reason"
                [(ngModel)]="form.reason" 
                name="reason" 
                class="form-control"
                rows="4"
                placeholder="Please describe your symptoms or reason for the appointment..."
                required></textarea>
              <small class="form-text text-muted">
                <i class="fas fa-info-circle"></i>
                This information helps the doctor understand your needs better.
              </small>
            </div>

            <!-- Submit Button -->
            <div class="form-actions">
              <button type="submit" class="btn btn-primary btn-book">
                <i class="fas fa-check"></i>
                <span *ngIf="selectedDoctor?.doctor_type === 'permanent'">Join Queue</span>
                <span *ngIf="selectedDoctor?.doctor_type === 'visiting'">Book Appointment</span>
                <span *ngIf="!selectedDoctor">Book Appointment</span>
              </button>
            </div>
          </form>

          <!-- Loading State -->
          <div *ngIf="loading" class="loading-overlay">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <p>Booking your appointment...</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>